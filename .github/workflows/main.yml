name: Databricks Login & Testsss

on:
  push:
    branches:
      - main

jobs:
  login_databricks_hvault:
    runs-on: self-hosted

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ðŸ”¹ Paso 1: Login en Vault (local en el runner)
      - name: Login en Vault
        shell: powershell
        env:
          VAULT_ADDR: http://127.0.0.1:8200
          VAULT_TOKEN: ${{ secrets.VAULT_TOKEN }}
          VAULT_SKIP_VERIFY: "true"
        run: |
          vault.exe login $env:VAULT_TOKEN
          vault.exe token lookup

      # ðŸ”¹ Paso 2: Obtener token de Databricks desde Vault
      - name: Obtener token de Databricks
        id: get-creds
        shell: powershell
        env:
          VAULT_ADDR: http://127.0.0.1:8200
          VAULT_SKIP_VERIFY: "true"
        run: |
          $dbToken = vault.exe kv get -field=DATABRICKS_TOKEN secret/azure
          echo "DATABRICKS_TOKEN=$dbToken" >> $env:GITHUB_OUTPUT

      # ðŸ”¹ Paso 3: Ejecutar Databricks CLI en Docker
      - name: Ejecutar comando Databricks CLI
        shell: powershell
        run: |
          docker run --rm `
            -e DATABRICKS_HOST="https://adb-3120226433905944.4.azuredatabricks.net" `
            -e DATABRICKS_TOKEN="${{ steps.get-creds.outputs.DATABRICKS_TOKEN }}" `
            databrickscli:python databricks clusters list

