name: Databricks-Job

on:
  push:
    branches:
      - reusable-databricks
  workflow_dispatch:

jobs:
  credentials:
    uses: ricardops2211/ci-cd-reusables/.github/workflows/credentials_azure.yml@databricks
    with:
      vault_addr: "http://127.0.0.1:8200"
      secret_path: "secret/azure"
      field: "DATABRICKS_TOKEN"
    secrets:
      VAULT_TOKEN: ${{ secrets.VAULT_TOKEN }}

  # (Opcional) Debug del output del reusable de credenciales
  debug-creds:
    needs: credentials
    runs-on: ubuntu-latest
    steps:
      - name: Verificar output de credentials
        run: |
          echo "len=${{ needs.credentials.outputs.databricks_token_len }}"
          echo "Nota: tus reusables no consumen este output; leen de Vault directamente."

  verify:
    needs: [credentials]   # mant√©n el orden que prefieras
    uses: ricardops2211/ci-cd-reusables/.github/workflows/verify_databricks.yml@databricks
    with:
      databricks_host: "https://adb-2011990214744919.19.azuredatabricks.net"
      # No pasar databricks_token: ese input no existe en el reusable
    secrets:
      VAULT_TOKEN: ${{ secrets.VAULT_TOKEN }}   # <-- requerido por el reusable

  deploy:
    needs: [verify]
    uses: ricardops2211/ci-cd-reusables/.github/workflows/deploy_databricks.yml@databricks
    with:
      databricks_host: "https://adb-2011990214744919.19.azuredatabricks.net"
      logs_dbfs_base: "dbfs:/cluster-logs"
      job_ids_path: ".gha/job_ids.json"
      # No pasar databricks_token: ese input no existe en el reusable
    secrets:
      VAULT_TOKEN: ${{ secrets.VAULT_TOKEN }}   # <-- requerido por el reusable
